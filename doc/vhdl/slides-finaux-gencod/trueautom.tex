\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{const}\PY{+w}{ }\PY{n}{n}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{int}\PY{+w}{ }\PY{o}{=}\PY{+w}{ }\PY{l+m+mi}{3}

\PY{k+kd}{node}\PY{+w}{ }\PY{k+kt}{int}\PY{n}{\PYZus{}of\PYZus{}bool}\PY{p}{(}\PY{n}{b}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{bool}\PY{p}{)}\PY{+w}{ }\PY{k}{returns}\PY{+w}{ }\PY{p}{(}\PY{n}{o}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{int}\PY{p}{)}
\PY{k}{let}\PY{+w}{ }\PY{n}{o}\PY{+w}{ }\PY{o}{=}\PY{+w}{ }\PY{k}{if}\PY{+w}{ }\PY{n}{b}\PY{+w}{ }\PY{k}{then}\PY{+w}{ }\PY{l+m+mi}{1}\PY{+w}{ }\PY{k}{else}\PY{+w}{ }\PY{l+m+mi}{0}\PY{+w}{ }\PY{k}{tel}

\PY{k+kd}{node}\PY{+w}{ }\PY{n}{countbits}\PY{p}{(}\PY{n}{x}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{bool}\PY{o}{\PYZca{}}\PY{n}{n}\PY{p}{;}\PY{+w}{ }\PY{n}{mask}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{bool}\PY{o}{\PYZca{}}\PY{n}{n}\PY{p}{;}\PY{+w}{ }\PY{n}{sw\PYZus{}mode}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{bool}\PY{p}{)}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{k}{returns}\PY{+w}{ }\PY{p}{(}\PY{n}{o}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{int}\PY{p}{)}
\PY{k+kd}{var}\PY{+w}{ }\PY{n}{bits}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{bool}\PY{o}{\PYZca{}}\PY{n}{n}\PY{p}{;}
\PY{k}{let}
\PY{+w}{ }\PY{+w}{ }\PY{k}{automaton}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{k}{state}\PY{+w}{ }\PY{l+s+ss}{Simple}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{k}{do}\PY{+w}{ }\PY{n}{bits}\PY{+w}{ }\PY{o}{=}\PY{+w}{ }\PY{n}{x}\PY{p}{;}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{k}{unless}\PY{+w}{ }\PY{n}{sw\PYZus{}mode}\PY{+w}{ }\PY{k}{then}\PY{+w}{ }\PY{l+s+ss}{Masked}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{k}{state}\PY{+w}{ }\PY{l+s+ss}{Masked}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{k}{do}\PY{+w}{ }\PY{n}{bits}\PY{+w}{ }\PY{o}{=}\PY{+w}{ }\PY{k}{map}\PY{+w}{ }\PY{p}{(}\PY{o}{&}\PY{p}{)}\PY{+w}{ }\PY{p}{<}\PY{p}{<}\PY{n}{n}\PY{p}{>}\PY{p}{>}\PY{p}{(}\PY{n}{x}\PY{p}{,}\PY{+w}{ }\PY{n}{mask}\PY{p}{)}\PY{p}{;}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{k}{unless}\PY{+w}{ }\PY{n}{sw\PYZus{}mode}\PY{+w}{ }\PY{k}{then}\PY{+w}{ }\PY{l+s+ss}{Simple}
\PY{+w}{ }\PY{+w}{ }\PY{k}{end}\PY{p}{;}

\PY{+w}{ }\PY{+w}{ }\PY{n}{o}\PY{+w}{ }\PY{o}{=}\PY{+w}{ }\PY{k}{fold}\PY{+w}{ }\PY{p}{(}\PY{o}{+}\PY{p}{)}\PY{+w}{ }\PY{p}{<}\PY{p}{<}\PY{n}{n}\PY{p}{>}\PY{p}{>}\PY{+w}{ }\PY{p}{(}\PY{k}{map}\PY{+w}{ }\PY{k+kt}{int}\PY{n}{\PYZus{}of\PYZus{}bool}\PY{+w}{ }\PY{p}{<}\PY{p}{<}\PY{n}{n}\PY{p}{>}\PY{p}{>}\PY{p}{(}\PY{n}{bits}\PY{p}{)}\PY{p}{,}\PY{+w}{ }\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{;}
\PY{k}{tel}

\PY{k+kd}{node}\PY{+w}{ }\PY{n}{main}\PY{p}{(}\PY{p}{)}\PY{+w}{ }\PY{k}{returns}\PY{+w}{ }\PY{p}{(}\PY{n}{o}\PY{+w}{ }\PY{p}{:}\PY{+w}{ }\PY{k+kt}{int}\PY{p}{)}
\PY{k}{let}
\PY{+w}{ }\PY{+w}{ }\PY{n}{o}\PY{+w}{ }\PY{o}{=}\PY{+w}{ }\PY{n}{countbits}\PY{p}{(}\PY{p}{[}\PY{l}{true}\PY{p}{,}\PY{+w}{ }\PY{l}{false}\PY{p}{,}\PY{+w}{ }\PY{l}{false}\PY{p}{]}\PY{+w}{ }\PY{k}{fby}\PY{+w}{ }\PY{p}{[}\PY{l}{true}\PY{p}{,}\PY{+w}{ }\PY{l}{true}\PY{p}{,}\PY{+w}{ }\PY{l}{true}\PY{p}{]}\PY{p}{,}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{p}{[}\PY{l}{true}\PY{p}{,}\PY{+w}{ }\PY{l}{false}\PY{p}{,}\PY{+w}{ }\PY{l}{true}\PY{p}{]}\PY{p}{,}
\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{+w}{ }\PY{l}{false}\PY{+w}{ }\PY{k}{fby}\PY{+w}{ }\PY{l}{true}\PY{+w}{ }\PY{k}{fby}\PY{+w}{ }\PY{l}{true}\PY{+w}{ }\PY{k}{fby}\PY{+w}{ }\PY{l}{false}\PY{p}{)}\PY{p}{;}
\PY{k}{tel}
\end{Verbatim}
